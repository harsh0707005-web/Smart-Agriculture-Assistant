<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://public-frontend-cos.metadl.com/mgx/img/favicon.png" type="image/png">
    <title>Crop Diagnosis - Smart Agriculture Assistant</title>
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <!-- Language Toggle -->
    <div class="language-toggle">
        <button id="langToggle" onclick="toggleLanguage()">
            <span id="langText">‡≤ï‡≤®‡≥ç‡≤®‡≤°</span>
        </button>
    </div>

    <!-- Navigation Header -->
    <nav class="nav-header">
        <div class="container">
            <div class="nav-content">
                <h1 class="nav-title" id="pageTitle">üî¨ Crop Diagnosis</h1>
                <button class="back-btn" onclick="goBack()" id="backBtn">‚Üê Back</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="page-content">
        <div class="container">
            <!-- Upload Section -->
            <section class="upload-section">
                <div class="upload-card">
                    <h2 id="uploadTitle">Upload Crop Image for Analysis</h2>
                    <p id="uploadDesc">Take a clear photo of the affected plant or upload an existing image for AI-powered diagnosis.</p>
                    
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">üì∏</div>
                        <p id="uploadText">Click to upload or drag and drop image</p>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;">
                        <button class="upload-btn" id="uploadBtn" onclick="document.getElementById('imageInput').click()">
                            Choose Image
                        </button>
                    </div>
                    
                    <div class="image-preview" id="imagePreview" style="display: none;">
                        <img id="previewImg" alt="Uploaded crop image">
                        <button class="analyze-btn" id="analyzeBtn" onclick="analyzeCrop()">
                            üîç Analyze Crop
                        </button>
                    </div>
                </div>
            </section>

            <!-- Results Section -->
            <section class="results-section" id="resultsSection" style="display: none;">
                <div class="results-card">
                    <h2 id="resultsTitle">Diagnosis Results</h2>
                    <div id="diagnosisResults"></div>
                </div>
            </section>

            <!-- Quick Tips -->
            <section class="tips-section">
                <h2 id="tipsTitle">Photography Tips for Better Diagnosis</h2>
                <div class="tips-grid">
                    <div class="tip-card">
                        <div class="tip-icon">üí°</div>
                        <h3 id="tip1Title">Good Lighting</h3>
                        <p id="tip1Desc">Take photos in natural daylight for best results. Avoid shadows and artificial lighting.</p>
                    </div>
                    <div class="tip-card">
                        <div class="tip-icon">üéØ</div>
                        <h3 id="tip2Title">Focus on Problem</h3>
                        <p id="tip2Desc">Capture the affected area clearly. Include both healthy and diseased parts for comparison.</p>
                    </div>
                    <div class="tip-card">
                        <div class="tip-icon">üìè</div>
                        <h3 id="tip3Title">Proper Distance</h3>
                        <p id="tip3Desc">Maintain 6-12 inches distance from the plant. Ensure the image is not blurry.</p>
                    </div>
                    <div class="tip-card">
                        <div class="tip-icon">üåø</div>
                        <h3 id="tip4Title">Multiple Angles</h3>
                        <p id="tip4Desc">Take photos from different angles - top, side, and close-up of affected areas.</p>
                    </div>
                </div>
            </section>

            <!-- Common Issues -->
            <section class="common-issues">
                <h2 id="commonTitle">Common Crop Issues in Karnataka</h2>
                <div class="issues-grid">
                    <div class="issue-card">
                        <h3>üçÖ Tomato Early Blight</h3>
                        <p><strong>Symptoms:</strong> Dark spots with concentric rings on leaves</p>
                        <p><strong>Treatment:</strong> Copper-based fungicides, proper spacing</p>
                    </div>
                    <div class="issue-card">
                        <h3>üåæ Rice Blast</h3>
                        <p><strong>Symptoms:</strong> Diamond-shaped lesions on leaves</p>
                        <p><strong>Treatment:</strong> Resistant varieties, balanced fertilization</p>
                    </div>
                    <div class="issue-card">
                        <h3>üåΩ Corn Borer</h3>
                        <p><strong>Symptoms:</strong> Holes in leaves and stems</p>
                        <p><strong>Treatment:</strong> Bt corn, biological control agents</p>
                    </div>
                    <div class="issue-card">
                        <h3>ü•î Potato Late Blight</h3>
                        <p><strong>Symptoms:</strong> Water-soaked spots turning brown</p>
                        <p><strong>Treatment:</strong> Preventive fungicide sprays</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal">
        <div class="modal-content">
            <div class="loading-content">
                <div class="spinner"></div>
                <h3 id="loadingTitle">Analyzing Your Crop...</h3>
                <p id="loadingDesc">Our AI is examining the image and comparing it with thousands of crop diseases.</p>
            </div>
        </div>
    </div>

    <style>
        .upload-section {
            margin-bottom: 3rem;
        }

        .upload-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .upload-card h2 {
            color: #2c5530;
            margin-bottom: 1rem;
        }

        .upload-area {
            border: 3px dashed #4CAF50;
            border-radius: 15px;
            padding: 3rem 2rem;
            margin: 2rem 0;
            background: #f8fff8;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #45a049;
            background: #f0fff0;
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .upload-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 1rem;
            transition: background 0.3s ease;
        }

        .upload-btn:hover {
            background: #45a049;
        }

        .image-preview {
            margin-top: 2rem;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        .analyze-btn {
            background: #FF9800;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .analyze-btn:hover {
            background: #F57C00;
        }

        .results-section {
            margin-bottom: 3rem;
        }

        .results-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .diagnosis-result {
            background: #f8fff8;
            border-left: 5px solid #4CAF50;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 0 10px 10px 0;
        }

        .confidence-bar {
            background: #e0e0e0;
            height: 10px;
            border-radius: 5px;
            margin: 0.5rem 0;
            overflow: hidden;
        }

        .confidence-fill {
            background: #4CAF50;
            height: 100%;
            transition: width 1s ease;
        }

        .tips-section, .common-issues {
            margin-bottom: 3rem;
        }

        .tips-grid, .issues-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .tip-card, .issue-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .tip-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .tip-card h3, .issue-card h3 {
            color: #2c5530;
            margin-bottom: 1rem;
        }

        .loading-content {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .upload-area {
                padding: 2rem 1rem;
            }
            
            .tips-grid, .issues-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script src="./config.js"></script>
    <script src="./script.js"></script>
    <script>
        // Diagnosis page specific functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize language
            if (typeof updateLanguage === 'function') {
                updateLanguage();
            }
            
            const imageInput = document.getElementById('imageInput');
            const previewImg = document.getElementById('previewImg');
            const imagePreview = document.getElementById('imagePreview');
            
            imageInput.addEventListener('change', function() {
                handleImageUpload(this, previewImg);
                imagePreview.style.display = 'block';
            });
        });

        async function analyzeCrop() {
            const imageInput = document.getElementById('imageInput');
            const loadingModal = document.getElementById('loadingModal');
            const resultsSection = document.getElementById('resultsSection');
            const resultsDiv = document.getElementById('diagnosisResults');
            
            // Check if image is selected
            if (!imageInput.files || !imageInput.files[0]) {
                alert('Please select an image first!');
                return;
            }
            
            const imageFile = imageInput.files[0];
            
            // Show loading modal
            loadingModal.style.display = 'block';
            
            try {
                // Call backend API to detect disease
                const diagnosis = await window.agricultureAPI.detectCropDisease(imageFile);
                
                // Hide loading modal
                loadingModal.style.display = 'none';
                
                // Show results from backend
                resultsDiv.innerHTML = `
                    <div class="diagnosis-result">
                        <h3>üéØ Detected Issue: ${diagnosis.disease || diagnosis.class || 'Unknown'}</h3>
                        <div class="confidence-section">
                            <p><strong>Confidence Level: ${diagnosis.confidence ? (diagnosis.confidence * 100).toFixed(1) : '0'}%</strong></p>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${diagnosis.confidence ? (diagnosis.confidence * 100) : 0}%"></div>
                            </div>
                        </div>
                        <div class="treatment-section">
                            <h4>üíä Recommended Treatment:</h4>
                            <p>${diagnosis.treatment || diagnosis.recommendation || 'Consult with an agricultural expert for specific treatment.'}</p>
                        </div>
                        <div class="prevention-section">
                            <h4>üõ°Ô∏è Prevention Tips:</h4>
                            <p>${diagnosis.prevention || diagnosis.preventive_measures || 'Maintain proper crop spacing, use disease-resistant varieties, and practice crop rotation.'}</p>
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn" onclick="contactExpert()">
                                <span class="btn-text" data-en="üë®‚Äçüåæ Contact Expert" data-hi="üë®‚Äçüåæ ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç" data-mr="üë®‚Äçüåæ ‡§§‡§ú‡•ç‡§û‡§æ‡§Ç‡§∂‡•Ä ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§∏‡§æ‡§ß‡§æ" data-kn="üë®‚Äçüåæ ‡≤§‡≤ú‡≥ç‡≤û‡≤∞‡≤®‡≥ç‡≤®‡≥Å ‡≤∏‡≤Ç‡≤™‡≤∞‡≥ç‡≤ï‡≤ø‡≤∏‡≤ø">üë®‚Äçüåæ Contact Expert</span>
                            </button>
                            <button class="action-btn" onclick="findNearbyStore()">
                                <span class="btn-text" data-en="üè™ Find Nearby Store" data-hi="üè™ ‡§®‡§ú‡§¶‡•Ä‡§ï‡•Ä ‡§¶‡•Å‡§ï‡§æ‡§® ‡§ñ‡•ã‡§ú‡•á‡§Ç" data-mr="üè™ ‡§ú‡§µ‡§≥‡§ö‡•á ‡§¶‡•Å‡§ï‡§æ‡§® ‡§∂‡•ã‡§ß‡§æ" data-kn="üè™ ‡≤π‡≤§‡≥ç‡≤§‡≤ø‡≤∞‡≤¶ ‡≤Ö‡≤Ç‡≤ó‡≤°‡≤ø ‡≤π‡≥Å‡≤°‡≥Å‡≤ï‡≤ø">üè™ Find Nearby Store</span>
                            </button>
                        </div>
                    </div>
                `;
                
                resultsSection.style.display = 'block';
                resultsSection.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                loadingModal.style.display = 'none';
                console.error('Analysis error:', error);
                
                // Show detailed error in results section
                resultsDiv.innerHTML = `
                    <div class="diagnosis-result" style="border-left-color: #f44336; background: #fff3f3;">
                        <h3>‚ùå Analysis Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px;">
                            <h4>üîß Troubleshooting Steps:</h4>
                            <ol style="text-align: left; margin-left: 1rem;">
                                <li><strong>Check Backend Server:</strong> Ensure backend is running and accessible</li>
                                <li><strong>Test Backend:</strong> Open <code>/api/health</code> (port 5001) in browser</li>
                                <li><strong>Check Endpoint:</strong> Verify <code>/detect</code> endpoint exists on backend</li>
                                <li><strong>CORS Settings:</strong> Backend must allow requests from frontend</li>
                                <li><strong>Image Format:</strong> Ensure image is JPG, PNG, or supported format</li>
                                <li><strong>Network:</strong> Check if frontend can reach backend IP</li>
                            </ol>
                            <p style="margin-top: 1rem;"><strong>Console:</strong> Press F12 to see detailed error logs</p>
                        </div>
                    </div>
                `;
                resultsSection.style.display = 'block';
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function contactExpert() {
            const modal = document.getElementById('loadingModal');
            const loadingTitle = document.getElementById('loadingTitle');
            const loadingDesc = document.getElementById('loadingDesc');
            
            const lang = currentLang || 'en';
            const messages = {
                en: {
                    loading: 'Connecting to Expert...',
                    loadingDesc: 'Finding the best agricultural expert for your issue.',
                    assigned: 'Expert Assigned!',
                    name: 'Name',
                    specialization: 'Specialization',
                    phone: 'Phone',
                    email: 'Email',
                    location: 'Location',
                    availability: 'Availability',
                    requestId: 'Request ID',
                    estimatedResponse: 'Estimated Response',
                    error: 'Failed to contact expert. Please try again or call helpline: 1800-180-1551'
                },
                hi: {
                    loading: '‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...',
                    loadingDesc: '‡§Ü‡§™‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§∞‡•ç‡§µ‡•ã‡§§‡•ç‡§§‡§Æ ‡§ï‡•É‡§∑‡§ø ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§ñ‡•ã‡§ú ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§',
                    assigned: '‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§®‡§ø‡§Ø‡•Å‡§ï‡•ç‡§§!',
                    name: '‡§®‡§æ‡§Æ',
                    specialization: '‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û‡§§‡§æ',
                    phone: '‡§´‡•ã‡§®',
                    email: '‡§à‡§Æ‡•á‡§≤',
                    location: '‡§∏‡•ç‡§•‡§æ‡§®',
                    availability: '‡§â‡§™‡§≤‡§¨‡•ç‡§ß‡§§‡§æ',
                    requestId: '‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§Ü‡§à‡§°‡•Ä',
                    estimatedResponse: '‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ',
                    error: '‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§π‡•á‡§≤‡•ç‡§™‡§≤‡§æ‡§á‡§® ‡§™‡§∞ ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç: 1800-180-1551'
                },
                mr: {
                    loading: '‡§§‡§ú‡•ç‡§û‡§æ‡§Ç‡§∂‡•Ä ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§∏‡§æ‡§ß‡§§ ‡§Ü‡§π‡•á...',
                    loadingDesc: '‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡•á‡§∏‡§æ‡§†‡•Ä ‡§∏‡§∞‡•ç‡§µ‡•ã‡§§‡•ç‡§§‡§Æ ‡§ï‡•É‡§∑‡•Ä ‡§§‡§ú‡•ç‡§û ‡§∂‡•ã‡§ß‡§§ ‡§Ü‡§π‡•á‡•§',
                    assigned: '‡§§‡§ú‡•ç‡§û ‡§®‡§ø‡§Ø‡•Å‡§ï‡•ç‡§§!',
                    name: '‡§®‡§æ‡§µ',
                    specialization: '‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û‡§§‡§æ',
                    phone: '‡§´‡•ã‡§®',
                    email: '‡§à‡§Æ‡•á‡§≤',
                    location: '‡§∏‡•ç‡§•‡§æ‡§®',
                    availability: '‡§â‡§™‡§≤‡§¨‡•ç‡§ß‡§§‡§æ',
                    requestId: '‡§µ‡§ø‡§®‡§Ç‡§§‡•Ä ‡§Ü‡§Ø‡§°‡•Ä',
                    estimatedResponse: '‡§Ö‡§Ç‡§¶‡§æ‡§ú‡•á ‡§™‡•ç‡§∞‡§§‡§ø‡§∏‡§æ‡§¶',
                    error: '‡§§‡§ú‡•ç‡§û‡§æ‡§Ç‡§∂‡•Ä ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§∏‡§æ‡§ß‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§π‡•á‡§≤‡•ç‡§™‡§≤‡§æ‡§á‡§®‡§µ‡§∞ ‡§ï‡•â‡§≤ ‡§ï‡§∞‡§æ: 1800-180-1551'
                },
                kn: {
                    loading: '‡≤§‡≤ú‡≥ç‡≤û‡≤∞‡≤®‡≥ç‡≤®‡≥Å ‡≤∏‡≤Ç‡≤™‡≤∞‡≥ç‡≤ï‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü...',
                    loadingDesc: '‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤∏‡≤Æ‡≤∏‡≥ç‡≤Ø‡≥Ü‡≤ó‡≥Ü ‡≤â‡≤§‡≥ç‡≤§‡≤Æ ‡≤ï‡≥É‡≤∑‡≤ø ‡≤§‡≤ú‡≥ç‡≤û‡≤∞‡≤®‡≥ç‡≤®‡≥Å ‡≤π‡≥Å‡≤°‡≥Å‡≤ï‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü.',
                    assigned: '‡≤§‡≤ú‡≥ç‡≤û‡≤∞‡≤®‡≥ç‡≤®‡≥Å ‡≤®‡≤ø‡≤Ø‡≥ã‡≤ú‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü!',
                    name: '‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å',
                    specialization: '‡≤µ‡≤ø‡≤∂‡≥á‡≤∑‡≤§‡≥Ü',
                    phone: '‡≤´‡≥ã‡≤®‡≥ç',
                    email: '‡≤á‡≤Æ‡≥á‡≤≤‡≥ç',
                    location: '‡≤∏‡≥ç‡≤•‡≤≥',
                    availability: '‡≤≤‡≤≠‡≥ç‡≤Ø‡≤§‡≥Ü',
                    requestId: '‡≤µ‡≤ø‡≤®‡≤Ç‡≤§‡≤ø ‡≤ê‡≤°‡≤ø',
                    estimatedResponse: '‡≤Ö‡≤Ç‡≤¶‡≤æ‡≤ú‡≥Å ‡≤™‡≥ç‡≤∞‡≤§‡≤ø‡≤ï‡≥ç‡≤∞‡≤ø‡≤Ø‡≥Ü',
                    error: '‡≤§‡≤ú‡≥ç‡≤û‡≤∞‡≤®‡≥ç‡≤®‡≥Å ‡≤∏‡≤Ç‡≤™‡≤∞‡≥ç‡≤ï‡≤ø‡≤∏‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü. ‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤Æ‡≤§‡≥ç‡≤§‡≥Ü ‡≤™‡≥ç‡≤∞‡≤Ø‡≤§‡≥ç‡≤®‡≤ø‡≤∏‡≤ø ‡≤Ö‡≤•‡≤µ‡≤æ ‡≤π‡≥Ü‡≤≤‡≥ç‡≤™‡≥ç‚Äå‡≤≤‡≥à‡≤®‡≥ç‚Äå‡≤ó‡≥Ü ‡≤ï‡≤∞‡≥Ü ‡≤Æ‡≤æ‡≤°‡≤ø: 1800-180-1551'
                }
            };
            
            const msg = messages[lang] || messages.en;
            
            loadingTitle.textContent = msg.loading;
            loadingDesc.textContent = msg.loadingDesc;
            modal.style.display = 'block';
            
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/expert/request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'Farmer',
                        phone: '+91 9876543210',
                        cropType: 'general',
                        issue: 'Crop disease consultation needed',
                        language: lang,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (!response.ok) throw new Error('Failed to contact expert');
                
                const data = await response.json();
                modal.style.display = 'none';
                
                // Show expert details
                if (data.success && data.expert_assigned) {
                    alert(`${msg.assigned}\n\n${msg.name}: ${data.expert_assigned.name}\n${msg.specialization}: ${data.expert_assigned.specialization}\n${msg.phone}: ${data.expert_assigned.phone}\n\n${msg.requestId}: ${data.request_id}\n${msg.estimatedResponse}: ${data.estimated_callback_time}`);
                } else {
                    alert(`${msg.assigned}\n\n${msg.requestId}: ${data.request_id}\n${msg.estimatedResponse}: ${data.estimated_callback_time || '30 minutes'}`);
                }
                
            } catch (error) {
                modal.style.display = 'none';
                console.error('Error contacting expert:', error);
                // Fallback: Open expert contact modal instead
                if (typeof showExpertContact === 'function') {
                    showExpertContact();
                } else {
                    alert(msg.error);
                }
            }
        }

        async function findNearbyStore() {
            const modal = document.getElementById('loadingModal');
            const loadingTitle = document.getElementById('loadingTitle');
            const loadingDesc = document.getElementById('loadingDesc');
            
            const lang = currentLang || 'en';
            const messages = {
                en: {
                    loading: 'Finding Nearby Stores...',
                    loadingDesc: 'Searching for agricultural stores in your area.',
                    found: 'Found',
                    storesNearby: 'Stores Nearby',
                    type: 'Type',
                    address: 'Address',
                    phone: 'Phone',
                    distance: 'Distance',
                    rating: 'Rating',
                    status: 'Status',
                    openNow: 'Open Now',
                    closed: 'Closed',
                    services: 'Services',
                    getDirections: 'Get Directions',
                    error: 'Failed to find nearby stores. Please try again or search manually on Google Maps.'
                },
                hi: {
                    loading: '‡§®‡§ú‡§¶‡•Ä‡§ï‡•Ä ‡§¶‡•Å‡§ï‡§æ‡§®‡•á‡§Ç ‡§ñ‡•ã‡§ú ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...',
                    loadingDesc: '‡§Ü‡§™‡§ï‡•á ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§Æ‡•á‡§Ç ‡§ï‡•É‡§∑‡§ø ‡§¶‡•Å‡§ï‡§æ‡§®‡•á‡§Ç ‡§ñ‡•ã‡§ú ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§',
                    found: '‡§Æ‡§ø‡§≤‡§æ',
                    storesNearby: '‡§®‡§ú‡§¶‡•Ä‡§ï‡•Ä ‡§¶‡•Å‡§ï‡§æ‡§®‡•á‡§Ç',
                    type: '‡§™‡•ç‡§∞‡§ï‡§æ‡§∞',
                    address: '‡§™‡§§‡§æ',
                    phone: '‡§´‡•ã‡§®',
                    distance: '‡§¶‡•Ç‡§∞‡•Ä',
                    rating: '‡§∞‡•á‡§ü‡§ø‡§Ç‡§ó',
                    status: '‡§∏‡•ç‡§•‡§ø‡§§‡§ø',
                    openNow: '‡§Ö‡§≠‡•Ä ‡§ñ‡•Å‡§≤‡§æ ‡§π‡•à',
                    closed: '‡§¨‡§Ç‡§¶',
                    services: '‡§∏‡•á‡§µ‡§æ‡§è‡§Ç',
                    getDirections: '‡§¶‡§ø‡§∂‡§æ-‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç',
                    error: '‡§®‡§ú‡§¶‡•Ä‡§ï‡•Ä ‡§¶‡•Å‡§ï‡§æ‡§®‡•á‡§Ç ‡§ñ‡•ã‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ Google Maps ‡§™‡§∞ ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç‡•§'
                },
                mr: {
                    loading: '‡§ú‡§µ‡§≥‡§ö‡•Ä ‡§¶‡•Å‡§ï‡§æ‡§®‡•á ‡§∂‡•ã‡§ß‡§§ ‡§Ü‡§π‡•á...',
                    loadingDesc: '‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§æ‡§§ ‡§ï‡•É‡§∑‡•Ä ‡§¶‡•Å‡§ï‡§æ‡§®‡•á ‡§∂‡•ã‡§ß‡§§ ‡§Ü‡§π‡•á.',
                    found: '‡§∏‡§æ‡§™‡§°‡§≤‡•á',
                    storesNearby: '‡§ú‡§µ‡§≥‡§ö‡•Ä ‡§¶‡•Å‡§ï‡§æ‡§®‡•á',
                    type: '‡§™‡•ç‡§∞‡§ï‡§æ‡§∞',
                    address: '‡§™‡§§‡•ç‡§§‡§æ',
                    phone: '‡§´‡•ã‡§®',
                    distance: '‡§Ö‡§Ç‡§§‡§∞',
                    rating: '‡§∞‡•á‡§ü‡§ø‡§Ç‡§ó',
                    status: '‡§∏‡•ç‡§•‡§ø‡§§‡•Ä',
                    openNow: '‡§Ü‡§§‡§æ ‡§â‡§ò‡§°‡•á ‡§Ü‡§π‡•á',
                    closed: '‡§¨‡§Ç‡§¶',
                    services: '‡§∏‡•á‡§µ‡§æ',
                    getDirections: '‡§¶‡§ø‡§∂‡§æ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂ ‡§Æ‡§ø‡§≥‡§µ‡§æ',
                    error: '‡§ú‡§µ‡§≥‡§ö‡•Ä ‡§¶‡•Å‡§ï‡§æ‡§®‡•á ‡§∂‡•ã‡§ß‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ ‡§ï‡§ø‡§Ç‡§µ‡§æ Google Maps ‡§µ‡§∞ ‡§Æ‡•Ö‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤‡•Ä ‡§∂‡•ã‡§ß‡§æ.'
                },
                kn: {
                    loading: '‡≤π‡≤§‡≥ç‡≤§‡≤ø‡≤∞‡≤¶ ‡≤Ö‡≤Ç‡≤ó‡≤°‡≤ø‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤π‡≥Å‡≤°‡≥Å‡≤ï‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü...',
                    loadingDesc: '‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤™‡≥ç‡≤∞‡≤¶‡≥á‡≤∂‡≤¶‡≤≤‡≥ç‡≤≤‡≤ø ‡≤ï‡≥É‡≤∑‡≤ø ‡≤Ö‡≤Ç‡≤ó‡≤°‡≤ø‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤π‡≥Å‡≤°‡≥Å‡≤ï‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü.',
                    found: '‡≤ï‡≤Ç‡≤°‡≥Å‡≤¨‡≤Ç‡≤¶‡≤ø‡≤¶‡≥Ü',
                    storesNearby: '‡≤π‡≤§‡≥ç‡≤§‡≤ø‡≤∞‡≤¶ ‡≤Ö‡≤Ç‡≤ó‡≤°‡≤ø‡≤ó‡≤≥‡≥Å',
                    type: '‡≤™‡≥ç‡≤∞‡≤ï‡≤æ‡≤∞',
                    address: '‡≤µ‡≤ø‡≤≥‡≤æ‡≤∏',
                    phone: '‡≤´‡≥ã‡≤®‡≥ç',
                    distance: '‡≤¶‡≥Ç‡≤∞',
                    rating: '‡≤∞‡≥á‡≤ü‡≤ø‡≤Ç‡≤ó‡≥ç',
                    status: '‡≤∏‡≥ç‡≤•‡≤ø‡≤§‡≤ø',
                    openNow: '‡≤à‡≤ó ‡≤§‡≥Ü‡≤∞‡≥Ü‡≤¶‡≤ø‡≤¶‡≥Ü',
                    closed: '‡≤Æ‡≥Å‡≤ö‡≥ç‡≤ö‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü',
                    services: '‡≤∏‡≥á‡≤µ‡≥Ü‡≤ó‡≤≥‡≥Å',
                    getDirections: '‡≤®‡≤ø‡≤∞‡≥ç‡≤¶‡≥á‡≤∂‡≤®‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤™‡≤°‡≥Ü‡≤Ø‡≤ø‡≤∞‡≤ø',
                    error: '‡≤π‡≤§‡≥ç‡≤§‡≤ø‡≤∞‡≤¶ ‡≤Ö‡≤Ç‡≤ó‡≤°‡≤ø‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤π‡≥Å‡≤°‡≥Å‡≤ï‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü. ‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤Æ‡≤§‡≥ç‡≤§‡≥Ü ‡≤™‡≥ç‡≤∞‡≤Ø‡≤§‡≥ç‡≤®‡≤ø‡≤∏‡≤ø ‡≤Ö‡≤•‡≤µ‡≤æ Google Maps ‡≤®‡≤≤‡≥ç‡≤≤‡≤ø ‡≤π‡≤∏‡≥ç‡≤§‡≤ö‡≤æ‡≤≤‡≤ø‡≤§‡≤µ‡≤æ‡≤ó‡≤ø ‡≤π‡≥Å‡≤°‡≥Å‡≤ï‡≤ø.'
                }
            };
            
            const msg = messages[lang] || messages.en;
            
            loadingTitle.textContent = msg.loading;
            loadingDesc.textContent = msg.loadingDesc;
            modal.style.display = 'block';
            
            try {
                // Get user location or use default (Bangalore)
                const defaultLocation = {
                    latitude: 12.9716,
                    longitude: 77.5946
                };
                
                const response = await fetch(`${CONFIG.API_BASE_URL}/stores/nearby`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        latitude: defaultLocation.latitude,
                        longitude: defaultLocation.longitude,
                        radius: 10,
                        store_type: 'all'
                    })
                });
                
                if (!response.ok) throw new Error('Failed to find stores');
                
                const data = await response.json();
                modal.style.display = 'none';
                
                // Create stores display
                let storesHTML = '<div style="max-height: 400px; overflow-y: auto;">';
                storesHTML += `<h3>üè™ ${msg.found} ${data.count} ${msg.storesNearby}</h3>`;
                
                data.stores.forEach(store => {
                    storesHTML += `
                        <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; background: white;">
                            <h4 style="margin: 0 0 10px 0; color: #2c5530;">${store.name}</h4>
                            <p style="margin: 5px 0;"><strong>${msg.type}:</strong> ${store.type}</p>
                            <p style="margin: 5px 0;"><strong>${msg.address}:</strong> ${store.address}</p>
                            <p style="margin: 5px 0;"><strong>${msg.phone}:</strong> ${store.phone}</p>
                            <p style="margin: 5px 0;"><strong>${msg.distance}:</strong> ${store.distance} km</p>
                            ${store.rating ? `<p style="margin: 5px 0;"><strong>${msg.rating}:</strong> ${'‚≠ê'.repeat(Math.floor(store.rating))} ${store.rating}</p>` : ''}
                            ${store.is_open !== undefined ? `<p style="margin: 5px 0;"><strong>${msg.status}:</strong> ${store.is_open ? 'üü¢ ' + msg.openNow : 'üî¥ ' + msg.closed}</p>` : ''}
                            ${store.products && store.products.length > 0 ? `<p style="margin: 5px 0;"><strong>${msg.services}:</strong> ${store.products.join(', ')}</p>` : ''}
                            <a href="https://www.google.com/maps?q=${store.latitude},${store.longitude}" target="_blank" style="display: inline-block; margin-top: 10px; padding: 8px 15px; background: #4CAF50; color: white; text-decoration: none; border-radius: 5px;">üìç ${msg.getDirections}</a>
                        </div>
                    `;
                });
                
                storesHTML += '</div>';
                
                // Show in results section
                const resultsDiv = document.getElementById('diagnosisResults');
                resultsDiv.innerHTML = storesHTML;
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                modal.style.display = 'none';
                console.error('Error finding stores:', error);
                alert(msg.error);
            }
        }
    </script>
</body>

</html>